import requests
import json
import os
import time
import math
from datetime import datetime, timedelta

# --- ğŸ“ å…¨å° 368 é„‰é®å¸‚å€ç¶“ç·¯åº¦è³‡æ–™åº« ---
TOWN_GEO = {
    "åŸºéš†å¸‚ä»æ„›å€": [25.1276, 121.7392], "åŸºéš†å¸‚ä¿¡ç¾©å€": [25.1294, 121.7495], "åŸºéš†å¸‚ä¸­æ­£å€": [25.1408, 121.7588], "åŸºéš†å¸‚ä¸­å±±å€": [25.1444, 121.7303], "åŸºéš†å¸‚å®‰æ¨‚å€": [25.1232, 121.7169], "åŸºéš†å¸‚æš–æš–å€": [25.0998, 121.7335], "åŸºéš†å¸‚ä¸ƒå µå€": [25.0958, 121.7126],
    "è‡ºåŒ—å¸‚ä¸­æ­£å€": [25.0321, 121.5195], "è‡ºåŒ—å¸‚å¤§åŒå€": [25.0645, 121.5133], "è‡ºåŒ—å¸‚ä¸­å±±å€": [25.0685, 121.5332], "è‡ºåŒ—å¸‚æ¾å±±å€": [25.0583, 121.5586], "è‡ºåŒ—å¸‚å¤§å®‰å€": [25.0263, 121.5438], "è‡ºåŒ—å¸‚è¬è¯å€": [25.0313, 121.4988], "è‡ºåŒ—å¸‚ä¿¡ç¾©å€": [25.0326, 121.5647], "è‡ºåŒ—å¸‚å£«æ—å€": [25.1166, 121.5478], "è‡ºåŒ—å¸‚åŒ—æŠ•å€": [25.1320, 121.4987], "è‡ºåŒ—å¸‚å…§æ¹–å€": [25.0836, 121.5944], "è‡ºåŒ—å¸‚å—æ¸¯å€": [25.0381, 121.6074], "è‡ºåŒ—å¸‚æ–‡å±±å€": [24.9937, 121.5705],
    "æ–°åŒ—å¸‚æ¿æ©‹å€": [25.0116, 121.4594], "æ–°åŒ—å¸‚ä¸‰é‡å€": [25.0694, 121.4912], "æ–°åŒ—å¸‚ä¸­å’Œå€": [24.9939, 121.4965], "æ–°åŒ—å¸‚æ°¸å’Œå€": [25.0094, 121.5152], "æ–°åŒ—å¸‚æ–°èŠå€": [25.0360, 121.4496], "æ–°åŒ—å¸‚æ–°åº—å€": [24.9680, 121.5413], "æ–°åŒ—å¸‚æ¨¹æ—å€": [24.9859, 121.4172], "æ–°åŒ—å¸‚é¶¯æ­Œå€": [24.9542, 121.3484], "æ–°åŒ—å¸‚ä¸‰å³½å€": [24.9009, 121.3916], "æ–°åŒ—å¸‚æ·¡æ°´å€": [25.1764, 121.4429], "æ–°åŒ—å¸‚æ±æ­¢å€": [25.0664, 121.6601], "æ–°åŒ—å¸‚ç‘èŠ³å€": [25.1086, 121.8058], "æ–°åŒ—å¸‚åœŸåŸå€": [24.9723, 121.4442], "æ–°åŒ—å¸‚è˜†æ´²å€": [25.0855, 121.4727], "æ–°åŒ—å¸‚äº”è‚¡å€": [25.0830, 121.4390], "æ–°åŒ—å¸‚æ³°å±±å€": [25.0594, 121.4276], "æ–°åŒ—å¸‚æ—å£å€": [25.0784, 121.3857], "æ–°åŒ—å¸‚æ·±å‘å€": [25.0019, 121.6152], "æ–°åŒ—å¸‚çŸ³ç¢‡å€": [24.9904, 121.6608], "æ–°åŒ—å¸‚åªæ—å€": [24.9351, 121.7107], "æ–°åŒ—å¸‚ä¸‰èŠå€": [25.2346, 121.5037], "æ–°åŒ—å¸‚çŸ³é–€å€": [25.2755, 121.5582], "æ–°åŒ—å¸‚å…«é‡Œå€": [25.1275, 121.4019], "æ–°åŒ—å¸‚å¹³æºªå€": [25.0255, 121.7397], "æ–°åŒ—å¸‚é›™æºªå€": [25.0287, 121.8541], "æ–°åŒ—å¸‚è²¢å¯®å€": [25.0213, 121.9224], "æ–°åŒ—å¸‚é‡‘å±±å€": [25.2154, 121.6166], "æ–°åŒ—å¸‚è¬é‡Œå€": [25.1724, 121.6669], "æ–°åŒ—å¸‚çƒä¾†å€": [24.8192, 121.5501],
    "æ¡ƒåœ’å¸‚æ¡ƒåœ’å€": [24.9936, 121.3010], "æ¡ƒåœ’å¸‚ä¸­å£¢å€": [24.9654, 121.2255], "æ¡ƒåœ’å¸‚å¤§æºªå€": [24.8806, 121.2866], "æ¡ƒåœ’å¸‚æ¥Šæ¢…å€": [24.9087, 121.1458], "æ¡ƒåœ’å¸‚è˜†ç«¹å€": [25.0504, 121.2891], "æ¡ƒåœ’å¸‚å¤§åœ’å€": [25.0631, 121.1963], "æ¡ƒåœ’å¸‚é¾œå±±å€": [25.0000, 121.3556], "æ¡ƒåœ’å¸‚å…«å¾·å€": [24.9493, 121.2965], "æ¡ƒåœ’å¸‚é¾æ½­å€": [24.8638, 121.2163], "æ¡ƒåœ’å¸‚å¹³é®å€": [24.9443, 121.2131], "æ¡ƒåœ’å¸‚æ–°å±‹å€": [24.9708, 121.1039], "æ¡ƒåœ’å¸‚è§€éŸ³å€": [25.0347, 121.0827], "æ¡ƒåœ’å¸‚å¾©èˆˆå€": [24.8213, 121.3524],
    "æ–°ç«¹å¸‚æ±å€": [24.8016, 121.0062], "æ–°ç«¹å¸‚åŒ—å€": [24.8142, 120.9575], "æ–°ç«¹å¸‚é¦™å±±å€": [24.7679, 120.9254],
    "æ–°ç«¹ç¸£ç«¹åŒ—å¸‚": [24.8420, 121.0022], "æ–°ç«¹ç¸£ç«¹æ±é®": [24.7335, 121.0821], "æ–°ç«¹ç¸£æ–°åŸ”é®": [24.8306, 121.0728], "æ–°ç«¹ç¸£é—œè¥¿é®": [24.7888, 121.1822], "æ–°ç«¹ç¸£æ¹–å£é„‰": [24.9038, 121.0427], "æ–°ç«¹ç¸£æ–°è±é„‰": [24.8732, 120.9859], "æ–°ç«¹ç¸£èŠæ—é„‰": [24.7744, 121.0772], "æ–°ç«¹ç¸£æ©«å±±é„‰": [24.7119, 121.1165], "æ–°ç«¹ç¸£åŒ—åŸ”é„‰": [24.6908, 121.0558], "æ–°ç«¹ç¸£å¯¶å±±é„‰": [24.7336, 121.0261], "æ–°ç«¹ç¸£å³¨çœ‰é„‰": [24.6756, 121.0205], "æ–°ç«¹ç¸£å°–çŸ³é„‰": [24.6467, 121.3149], "æ–°ç«¹ç¸£äº”å³°é„‰": [24.5855, 121.1272],
    "è‹—æ —ç¸£è‹—æ —å¸‚": [24.5649, 120.8152], "è‹—æ —ç¸£é ­ä»½å¸‚": [24.6872, 120.9069], "è‹—æ —ç¸£è‹‘è£¡é®": [24.4265, 120.6725], "è‹—æ —ç¸£é€šéœ„é®": [24.4936, 120.6974], "è‹—æ —ç¸£ç«¹å—é®": [24.6932, 120.8711], "è‹—æ —ç¸£å¾Œé¾é®": [24.6200, 120.7936], "è‹—æ —ç¸£å“è˜­é®": [24.3168, 120.8354], "è‹—æ —ç¸£å¤§æ¹–é„‰": [24.4087, 120.8654], "è‹—æ —ç¸£å…¬é¤¨é„‰": [24.5029, 120.8322], "è‹—æ —ç¸£éŠ…é‘¼é„‰": [24.4746, 120.7941], "è‹—æ —ç¸£å—åº„é„‰": [24.5910, 121.0089], "è‹—æ —ç¸£é ­å±‹é„‰": [24.5768, 120.8655], "è‹—æ —ç¸£ä¸‰ç¾©é„‰": [24.3984, 120.7677], "è‹—æ —ç¸£è¥¿æ¹–é„‰": [24.5369, 120.7711], "è‹—æ —ç¸£é€ æ©‹é„‰": [24.6366, 120.8744], "è‹—æ —ç¸£ä¸‰ç£é„‰": [24.6548, 120.9507], "è‹—æ —ç¸£ç…æ½­é„‰": [24.5428, 120.9161], "è‹—æ —ç¸£æ³°å®‰é„‰": [24.4172, 121.0366],
    "è‡ºä¸­å¸‚ä¸­å€": [24.1413, 120.6806], "è‡ºä¸­å¸‚æ±å€": [24.1352, 120.7042], "è‡ºä¸­å¸‚å—å€": [24.1169, 120.6558], "è‡ºä¸­å¸‚è¥¿å€": [24.1408, 120.6562], "è‡ºä¸­å¸‚åŒ—å€": [24.1633, 120.6784], "è‡ºä¸­å¸‚è¥¿å±¯å€": [24.1793, 120.6358], "è‡ºä¸­å¸‚å—å±¯å€": [24.1328, 120.6063], "è‡ºä¸­å¸‚åŒ—å±¯å€": [24.1843, 120.7251], "è‡ºä¸­å¸‚è±åŸå€": [24.2505, 120.7231], "è‡ºä¸­å¸‚æ±å‹¢å€": [24.2393, 120.8407], "è‡ºä¸­å¸‚å¤§ç”²å€": [24.3481, 120.6384], "è‡ºä¸­å¸‚æ¸…æ°´å€": [24.2709, 120.5735], "è‡ºä¸­å¸‚æ²™é¹¿å€": [24.2263, 120.5772], "è‡ºä¸­å¸‚æ¢§æ£²å€": [24.2559, 120.5367], "è‡ºä¸­å¸‚åé‡Œå€": [24.3045, 120.7180], "è‡ºä¸­å¸‚ç¥å²¡å€": [24.2582, 120.6627], "è‡ºä¸­å¸‚æ½­å­å€": [24.2091, 120.7063], "è‡ºä¸­å¸‚å¤§é›…å€": [24.2274, 120.6482], "è‡ºä¸­å¸‚æ–°ç¤¾å€": [24.2157, 120.8242], "è‡ºä¸­å¸‚çŸ³å²¡å€": [24.2762, 120.7770], "è‡ºä¸­å¸‚å¤–åŸ”å€": [24.3168, 120.6491], "è‡ºä¸­å¸‚å¤§å®‰å€": [24.3562, 120.5849], "è‡ºä¸­å¸‚çƒæ—¥å€": [24.0898, 120.6334], "è‡ºä¸­å¸‚å¤§è‚šå€": [24.1528, 120.5486], "è‡ºä¸­å¸‚é¾äº•å€": [24.2023, 120.5435], "è‡ºä¸­å¸‚éœ§å³°å€": [24.0450, 120.7139], "è‡ºä¸­å¸‚å¤ªå¹³å€": [24.1197, 120.7816], "è‡ºä¸­å¸‚å¤§é‡Œå€": [24.0883, 120.6953], "è‡ºä¸­å¸‚å’Œå¹³å€": [24.2882, 121.0965],
    "å½°åŒ–ç¸£å½°åŒ–å¸‚": [24.0792, 120.5459], "å½°åŒ–ç¸£é¹¿æ¸¯é®": [24.0569, 120.4357], "å½°åŒ–ç¸£å’Œç¾é®": [24.1118, 120.5002], "å½°åŒ–ç¸£ç·šè¥¿é„‰": [24.1332, 120.4705], "å½°åŒ–ç¸£ä¼¸æ¸¯é„‰": [24.1554, 120.4906], "å½°åŒ–ç¸£ç¦èˆˆé„‰": [24.0381, 120.4429], "å½°åŒ–ç¸£ç§€æ°´é„‰": [24.0371, 120.5036], "å½°åŒ–ç¸£èŠ±å£‡é„‰": [24.0256, 120.5532], "å½°åŒ–ç¸£èŠ¬åœ’é„‰": [24.0135, 120.6277], "å½°åŒ–ç¸£å“¡æ—å¸‚": [23.9592, 120.5731], "å½°åŒ–ç¸£æºªæ¹–é®": [23.9576, 120.4851], "å½°åŒ–ç¸£ç”°ä¸­é®": [23.8606, 120.5878], "å½°åŒ–ç¸£å¤§æ‘é„‰": [23.9934, 120.5436], "å½°åŒ–ç¸£åŸ”é¹½é„‰": [23.9961, 120.4635], "å½°åŒ–ç¸£åŸ”å¿ƒé„‰": [23.9535, 120.5317], "å½°åŒ–ç¸£æ°¸é–é„‰": [23.9213, 120.5484], "å½°åŒ–ç¸£ç¤¾é ­é„‰": [23.8967, 120.5822], "å½°åŒ–ç¸£äºŒæ°´é„‰": [23.8078, 120.6179], "å½°åŒ–ç¸£åŒ—æ–—é®": [23.8749, 120.5233], "å½°åŒ–ç¸£äºŒæ—é®": [23.8986, 120.3789], "å½°åŒ–ç¸£ç”°å°¾é„‰": [23.8914, 120.5273], "å½°åŒ–ç¸£åŸ¤é ­é„‰": [23.8631, 120.4571], "å½°åŒ–ç¸£èŠ³è‹‘é„‰": [23.9318, 120.3340], "å½°åŒ–ç¸£å¤§åŸé„‰": [23.8569, 120.3236], "å½°åŒ–ç¸£ç«¹å¡˜é„‰": [23.8504, 120.4170], "å½°åŒ–ç¸£æºªå·é„‰": [23.8517, 120.5029],
    "å—æŠ•ç¸£å—æŠ•å¸‚": [23.9189, 120.6728], "å—æŠ•ç¸£åŸ”é‡Œé®": [23.9654, 120.9631], "å—æŠ•ç¸£è‰å±¯é®": [23.9882, 120.6974], "å—æŠ•ç¸£ç«¹å±±é®": [23.7549, 120.6865], "å—æŠ•ç¸£é›†é›†é®": [23.8293, 120.7854], "å—æŠ•ç¸£åé–“é„‰": [23.8703, 120.6713], "å—æŠ•ç¸£é¹¿è°·é„‰": [23.7441, 120.7516], "å—æŠ•ç¸£ä¸­å¯®é„‰": [23.8969, 120.7629], "å—æŠ•ç¸£é­šæ± é„‰": [23.8953, 120.9328], "å—æŠ•ç¸£åœ‹å§“é„‰": [24.0436, 120.8523], "å—æŠ•ç¸£æ°´é‡Œé„‰": [23.8115, 120.8509], "å—æŠ•ç¸£ä¿¡ç¾©é„‰": [23.6936, 120.9702], "å—æŠ•ç¸£ä»æ„›é„‰": [24.0242, 121.1309],
    "é›²æ—ç¸£æ–—å…­å¸‚": [23.7081, 120.5441], "é›²æ—ç¸£æ–—å—é®": [23.6766, 120.4851], "é›²æ—ç¸£è™å°¾é®": [23.7088, 120.4357], "é›²æ—ç¸£è¥¿èºé®": [23.7917, 120.4636], "é›²æ—ç¸£åœŸåº«é®": [23.6796, 120.3853], "é›²æ—ç¸£åŒ—æ¸¯é®": [23.5786, 120.2981], "é›²æ—ç¸£å¤å‘é„‰": [23.6262, 120.5898], "é›²æ—ç¸£å¤§åŸ¤é„‰": [23.6421, 120.4288], "é›²æ—ç¸£è¿æ¡é„‰": [23.7635, 120.5284], "é›²æ—ç¸£æ—å…§é„‰": [23.7601, 120.6121], "é›²æ—ç¸£äºŒå´™é„‰": [23.7744, 120.4172], "é›²æ—ç¸£å´™èƒŒé„‰": [23.7588, 120.3547], "é›²æ—ç¸£éº¥å¯®é„‰": [23.7533, 120.2529], "é›²æ—ç¸£æ±å‹¢é„‰": [23.6781, 120.2575], "é›²æ—ç¸£è¤’å¿ é„‰": [23.6983, 120.3135], "é›²æ—ç¸£è‡ºè¥¿é„‰": [23.7032, 120.2030], "é›²æ—ç¸£å…ƒé•·é„‰": [23.6457, 120.3129], "é›²æ—ç¸£å››æ¹–é„‰": [23.6397, 120.2227], "é›²æ—ç¸£å£æ¹–é„‰": [23.5721, 120.1834], "é›²æ—ç¸£æ°´æ—é„‰": [23.5683, 120.2464],
    "å˜‰ç¾©å¸‚æ±å€": [23.4839, 120.4646], "å˜‰ç¾©å¸‚è¥¿å€": [23.4796, 120.4293],
    "å˜‰ç¾©ç¸£å¤ªä¿å¸‚": [23.4588, 120.3298], "å˜‰ç¾©ç¸£æœ´å­å¸‚": [23.4660, 120.2443], "å˜‰ç¾©ç¸£å¸ƒè¢‹é®": [23.3768, 120.1717], "å˜‰ç¾©ç¸£å¤§æ—é®": [23.6009, 120.4659], "å˜‰ç¾©ç¸£æ°‘é›„é„‰": [23.5483, 120.4431], "å˜‰ç¾©ç¸£æºªå£é„‰": [23.6067, 120.3957], "å˜‰ç¾©ç¸£æ–°æ¸¯é„‰": [23.5516, 120.3475], "å˜‰ç¾©ç¸£å…­è…³é„‰": [23.4984, 120.2917], "å˜‰ç¾©ç¸£æ±çŸ³é„‰": [23.4568, 120.1746], "å˜‰ç¾©ç¸£ç¾©ç«¹é„‰": [23.3364, 120.2452], "å˜‰ç¾©ç¸£é¹¿è‰é„‰": [23.4116, 120.3126], "å˜‰ç¾©ç¸£æ°´ä¸Šé„‰": [23.4284, 120.4140], "å˜‰ç¾©ç¸£ä¸­åŸ”é„‰": [23.4184, 120.5298], "å˜‰ç¾©ç¸£ç«¹å´é„‰": [23.5049, 120.5843], "å˜‰ç¾©ç¸£æ¢…å±±é„‰": [23.5728, 120.6166], "å˜‰ç¾©ç¸£ç•ªè·¯é„‰": [23.4475, 120.6409], "å˜‰ç¾©ç¸£å¤§åŸ”é„‰": [23.2989, 120.6277], "å˜‰ç¾©ç¸£é˜¿é‡Œå±±é„‰": [23.4398, 120.7675],
    "è‡ºå—å¸‚æ–°ç‡Ÿå€": [23.3080, 120.3160], "è‡ºå—å¸‚é¹½æ°´å€": [23.3243, 120.2647], "è‡ºå—å¸‚ç™½æ²³å€": [23.3444, 120.4501], "è‡ºå—å¸‚æŸ³ç‡Ÿå€": [23.2842, 120.3424], "è‡ºå—å¸‚å¾Œå£å€": [23.3647, 120.3551], "è‡ºå—å¸‚æ±å±±å€": [23.3106, 120.4277], "è‡ºå—å¸‚éº»è±†å€": [23.1868, 120.2464], "è‡ºå—å¸‚ä¸‹ç‡Ÿå€": [23.2285, 120.2690], "è‡ºå—å¸‚å…­ç”²å€": [23.2241, 120.3424], "è‡ºå—å¸‚å®˜ç”°å€": [23.1906, 120.3392], "è‡ºå—å¸‚å¤§å…§å€": [23.1232, 120.3756], "è‡ºå—å¸‚ä½³é‡Œå€": [23.1672, 120.1764], "è‡ºå—å¸‚å­¸ç”²å€": [23.2359, 120.1802], "è‡ºå—å¸‚è¥¿æ¸¯å€": [23.1233, 120.2036], "è‡ºå—å¸‚ä¸ƒè‚¡å€": [23.1408, 120.1348], "è‡ºå—å¸‚å°‡è»å€": [23.1994, 120.1420], "è‡ºå—å¸‚åŒ—é–€å€": [23.2676, 120.1246], "è‡ºå—å¸‚æ–°åŒ–å€": [23.0384, 120.3090], "è‡ºå—å¸‚å–„åŒ–å€": [23.1326, 120.2929], "è‡ºå—å¸‚æ–°å¸‚å€": [23.0782, 120.2934], "è‡ºå—å¸‚å®‰å®šå€": [23.1193, 120.2351], "è‡ºå—å¸‚å±±ä¸Šå€": [23.0970, 120.3708], "è‡ºå—å¸‚ç‰äº•å€": [23.1259, 120.4619], "è‡ºå—å¸‚æ¥ è¥¿å€": [23.1895, 120.5050], "è‡ºå—å¸‚å—åŒ–å€": [23.0805, 120.5204], "è‡ºå—å¸‚å·¦é®å€": [23.0456, 120.4260], "è‡ºå—å¸‚ä»å¾·å€": [22.9554, 120.2541], "è‡ºå—å¸‚æ­¸ä»å€": [22.9666, 120.2949], "è‡ºå—å¸‚é—œå»Ÿå€": [22.9563, 120.3444], "è‡ºå—å¸‚é¾å´å€": [22.9515, 120.3951], "è‡ºå—å¸‚æ°¸åº·å€": [23.0232, 120.2574], "è‡ºå—å¸‚æ±å€": [22.9839, 120.2227], "è‡ºå—å¸‚å—å€": [22.9585, 120.1843], "è‡ºå—å¸‚åŒ—å€": [23.0076, 120.2058], "è‡ºå—å¸‚å®‰å—å€": [23.0478, 120.1834], "è‡ºå—å¸‚å®‰å¹³å€": [23.0003, 120.1607], "è‡ºå—å¸‚ä¸­è¥¿å€": [22.9926, 120.1979],
    "é«˜é›„å¸‚é¹½åŸ•å€": [22.6247, 120.2839], "é«˜é›„å¸‚é¼“å±±å€": [22.6524, 120.2735], "é«˜é›„å¸‚å·¦ç‡Ÿå€": [22.6865, 120.2952], "é«˜é›„å¸‚æ¥ æ¢“å€": [22.7291, 120.3276], "é«˜é›„å¸‚ä¸‰æ°‘å€": [22.6508, 120.3235], "é«˜é›„å¸‚æ–°èˆˆå€": [22.6284, 120.3087], "é«˜é›„å¸‚å‰é‡‘å€": [22.6268, 120.2941], "é«˜é›„å¸‚è‹“é›…å€": [22.6253, 120.3340], "é«˜é›„å¸‚å‰é®å€": [22.5852, 120.3168], "é«˜é›„å¸‚æ——æ´¥å€": [22.5714, 120.2797], "é«˜é›„å¸‚å°æ¸¯å€": [22.5484, 120.3661], "é«˜é›„å¸‚é³³å±±å€": [22.6176, 120.3637], "é«˜é›„å¸‚æ—åœ’å€": [22.4975, 120.3958], "é«˜é›„å¸‚å¤§å¯®å€": [22.6025, 120.4103], "é«˜é›„å¸‚å¤§æ¨¹å€": [22.6841, 120.4435], "é«˜é›„å¸‚å¤§ç¤¾å€": [22.7303, 120.3546], "é«˜é›„å¸‚ä»æ­¦å€": [22.7001, 120.3551], "é«˜é›„å¸‚é³¥æ¾å€": [22.6599, 120.3758], "é«˜é›„å¸‚å²¡å±±å€": [22.8094, 120.2858], "é«˜é›„å¸‚æ©‹é ­å€": [22.7570, 120.3045], "é«˜é›„å¸‚ç‡•å·¢å€": [22.7876, 120.3705], "é«˜é›„å¸‚ç”°å¯®å€": [22.8687, 120.3804], "é«˜é›„å¸‚é˜¿è“®å€": [22.8874, 120.3259], "é«˜é›„å¸‚è·¯ç«¹å€": [22.8654, 120.2580], "é«˜é›„å¸‚æ¹–å…§å€": [22.9056, 120.2241], "é«˜é›„å¸‚èŒ„è£å€": [22.9037, 120.1868], "é«˜é›„å¸‚æ°¸å®‰å€": [22.8166, 120.2285], "é«˜é›„å¸‚å½Œé™€å€": [22.7816, 120.2443], "é«˜é›„å¸‚æ¢“å®˜å€": [22.7569, 120.2649], "é«˜é›„å¸‚æ——å±±å€": [22.8986, 120.4795], "é«˜é›„å¸‚ç¾æ¿ƒå€": [22.9055, 120.5401], "é«˜é›„å¸‚å…­é¾œå€": [23.0033, 120.6559], "é«˜é›„å¸‚ç”²ä»™å€": [23.1009, 120.6139], "é«˜é›„å¸‚æ‰æ—å€": [22.9918, 120.5408], "é«˜é›„å¸‚å…§é–€å€": [22.9463, 120.4630], "é«˜é›„å¸‚èŒ‚æ—å€": [22.8931, 120.6975], "é«˜é›„å¸‚æ¡ƒæºå€": [23.1950, 120.8066], "é«˜é›„å¸‚é‚£ç‘ªå¤å€": [23.2427, 120.7107],
    "å±æ±ç¸£å±æ±å¸‚": [22.6713, 120.4852], "å±æ±ç¸£æ½®å·é®": [22.5513, 120.5422], "å±æ±ç¸£æ±æ¸¯é®": [22.4674, 120.4526], "å±æ±ç¸£æ†æ˜¥é®": [22.0001, 120.7410], "å±æ±ç¸£è¬ä¸¹é„‰": [22.5855, 120.4842], "å±æ±ç¸£é•·æ²»é„‰": [22.6841, 120.5282], "å±æ±ç¸£éºŸæ´›é„‰": [22.6472, 120.5262], "å±æ±ç¸£ä¹å¦‚é„‰": [22.7397, 120.4883], "å±æ±ç¸£é‡Œæ¸¯é„‰": [22.7811, 120.4936], "å±æ±ç¸£é¹½åŸ”é„‰": [22.7473, 120.5739], "å±æ±ç¸£é«˜æ¨¹é„‰": [22.8256, 120.6015], "å±æ±ç¸£è¬å·’é„‰": [22.5746, 120.5898], "å±æ±ç¸£å…§åŸ”é„‰": [22.6258, 120.5794], "å±æ±ç¸£ç«¹ç”°é„‰": [22.5888, 120.5404], "å±æ±ç¸£æ–°åŸ¤é„‰": [22.4746, 120.5552], "å±æ±ç¸£æ‹å¯®é„‰": [22.3688, 120.5960], "å±æ±ç¸£æ–°åœ’é„‰": [22.5369, 120.4600], "å±æ±ç¸£å´é ‚é„‰": [22.5113, 120.5126], "å±æ±ç¸£æ—é‚Šé„‰": [22.4344, 120.5152], "å±æ±ç¸£å—å·é„‰": [22.4939, 120.5128], "å±æ±ç¸£ä½³å†¬é„‰": [22.4187, 120.5492], "å±æ±ç¸£ç‰çƒé„‰": [22.3458, 120.3664], "å±æ±ç¸£è»ŠåŸé„‰": [22.0722, 120.7126], "å±æ±ç¸£æ»¿å·é„‰": [22.0308, 120.8354], "å±æ±ç¸£æ‹å±±é„‰": [22.2570, 120.6548], "å±æ±ç¸£ä¸‰åœ°é–€é„‰": [22.7483, 120.6865], "å±æ±ç¸£éœ§è‡ºé„‰": [22.7460, 120.7303], "å±æ±ç¸£ç‘ªå®¶é„‰": [22.6517, 120.6627], "å±æ±ç¸£æ³°æ­¦é„‰": [22.6074, 120.6644], "å±æ±ç¸£ä¾†ç¾©é„‰": [22.5298, 120.6555], "å±æ±ç¸£æ˜¥æ—¥é„‰": [22.4042, 120.6548], "å±æ±ç¸£ç…å­é„‰": [22.2223, 120.7380], "å±æ±ç¸£ç‰¡ä¸¹é„‰": [22.1471, 120.8037],
    "å®œè˜­ç¸£å®œè˜­å¸‚": [24.7570, 121.7530], "å®œè˜­ç¸£ç¾…æ±é®": [24.6759, 121.7675], "å®œè˜­ç¸£è˜‡æ¾³é®": [24.5956, 121.8413], "å®œè˜­ç¸£é ­åŸé®": [24.8582, 121.8242], "å®œè˜­ç¸£ç¤æºªé„‰": [24.8214, 121.7684], "å®œè˜­ç¸£å£¯åœé„‰": [24.7645, 121.8020], "å®œè˜­ç¸£å“¡å±±é„‰": [24.7437, 121.7145], "å®œè˜­ç¸£å†¬å±±é„‰": [24.6366, 121.7904], "å®œè˜­ç¸£äº”çµé„‰": [24.6974, 121.7997], "å®œè˜­ç¸£ä¸‰æ˜Ÿé„‰": [24.6648, 121.6421], "å®œè˜­ç¸£å¤§åŒé„‰": [24.6368, 121.5721], "å®œè˜­ç¸£å—æ¾³é„‰": [24.4447, 121.7770],
    "èŠ±è“®ç¸£èŠ±è“®å¸‚": [23.9912, 121.6015], "èŠ±è“®ç¸£é³³æ—é®": [23.7547, 121.4646], "èŠ±è“®ç¸£ç‰é‡Œé®": [23.3610, 121.3289], "èŠ±è“®ç¸£æ–°åŸé„‰": [24.0360, 121.6247], "èŠ±è“®ç¸£å‰å®‰é„‰": [23.9748, 121.5833], "èŠ±è“®ç¸£å£½è±é„‰": [23.8647, 121.5222], "èŠ±è“®ç¸£å…‰å¾©é„‰": [23.6559, 121.4326], "èŠ±è“®ç¸£è±æ¿±é„‰": [23.6062, 121.5471], "èŠ±è“®ç¸£ç‘ç©—é„‰": [23.5186, 121.3837], "èŠ±è“®ç¸£å¯Œé‡Œé„‰": [23.1897, 121.2618], "èŠ±è“®ç¸£ç§€æ—é„‰": [24.1678, 121.6033], "èŠ±è“®ç¸£è¬æ¦®é„‰": [23.7550, 121.3789], "èŠ±è“®ç¸£å“æºªé„‰": [23.3621, 121.1685],
    "è‡ºæ±ç¸£è‡ºæ±å¸‚": [22.7554, 121.1504], "è‡ºæ±ç¸£æˆåŠŸé®": [23.1022, 121.3753], "è‡ºæ±ç¸£é—œå±±é®": [23.0487, 121.1633], "è‡ºæ±ç¸£å‘å—é„‰": [22.8252, 121.0538], "è‡ºæ±ç¸£é¹¿é‡é„‰": [22.9238, 121.1528], "è‡ºæ±ç¸£æ± ä¸Šé„‰": [23.1235, 121.2185], "è‡ºæ±ç¸£æ±æ²³é„‰": [22.9734, 121.2989], "è‡ºæ±ç¸£é•·æ¿±é„‰": [23.3155, 121.4552], "è‡ºæ±ç¸£å¤ªéº»é‡Œé„‰": [22.6154, 120.9996], "è‡ºæ±ç¸£å¤§æ­¦é„‰": [22.3617, 120.9080], "è‡ºæ±ç¸£ç¶ å³¶é„‰": [22.6669, 121.4816], "è‡ºæ±ç¸£æµ·ç«¯é„‰": [23.1904, 121.0544], "è‡ºæ±ç¸£å»¶å¹³é„‰": [22.9103, 121.0028], "è‡ºæ±ç¸£é‡‘å³°é„‰": [22.6087, 120.9575], "è‡ºæ±ç¸£é”ä»é„‰": [22.2965, 120.8529], "è‡ºæ±ç¸£è˜­å¶¼é„‰": [22.0526, 121.5487],
    "æ¾æ¹–ç¸£é¦¬å…¬å¸‚": [23.5658, 119.5630], "æ¾æ¹–ç¸£æ¹–è¥¿é„‰": [23.5855, 119.6483], "æ¾æ¹–ç¸£ç™½æ²™é„‰": [23.6496, 119.5937], "æ¾æ¹–ç¸£è¥¿å¶¼é„‰": [23.6030, 119.5168], "æ¾æ¹–ç¸£æœ›å®‰é„‰": [23.3688, 119.4996], "æ¾æ¹–ç¸£ä¸ƒç¾é„‰": [23.2088, 119.4283],
    "é‡‘é–€ç¸£é‡‘åŸé®": [24.4168, 118.3168], "é‡‘é–€ç¸£é‡‘æ²™é®": [24.4891, 118.4124], "é‡‘é–€ç¸£é‡‘æ¹–é®": [24.4449, 118.4111], "é‡‘é–€ç¸£é‡‘å¯§é„‰": [24.4557, 118.3242], "é‡‘é–€ç¸£çƒˆå¶¼é„‰": [24.4259, 118.2435], "é‡‘é–€ç¸£çƒåµé„‰": [24.9919, 119.4443],
    "é€£æ±Ÿç¸£å—ç«¿é„‰": [26.1578, 119.9329], "é€£æ±Ÿç¸£åŒ—ç«¿é„‰": [26.2239, 119.9965], "é€£æ±Ÿç¸£è’å…‰é„‰": [25.9736, 119.9404], "é€£æ±Ÿç¸£æ±å¼•é„‰": [26.3683, 120.4939]
}

def calculate_distance(lat1, lon1, lat2, lon2):
    R = 6371  
    dLat = math.radians(lat2 - lat1)
    dLon = math.radians(lon2 - lon1)
    a = math.sin(dLat/2) * math.sin(dLat/2) + \
        math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * \
        math.sin(dLon/2) * math.sin(dLon/2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    return R * c 

def get_taiwanese_quote(apparent_temp, weather, is_raining, wind_speed):
    advice = "å¤©æ°£å‰›å‰›å¥½ï¼Œå‡ºé–€èµ°èµ°å§ï¼" 
    if is_raining:
        if "å¤§é›¨" in weather or "è±ªé›¨" in weather:
            advice = "å¤–é¢è½å¤§é›¨ï¼Œé›¨å…·è¦å‚³è³€ (æº–å‚™å¥½)ï¼Œé¨è»Šå¡æ³¨æ„å®‰å…¨å–”ï¼"
        else:
            advice = "å¤–é¢åœ¨é£„é›¨ï¼Œå‡ºé–€è¨˜å¾—å¸¶æŠŠå‚˜ï¼Œèµ°è·¯å°å¿ƒæ»‘å€’ã€‚"
    elif wind_speed > 8:
        advice = "é¢¨é€é€ (é¢¨å¾ˆå¤§)ï¼Œé¨è»Šå®¹æ˜“é£„ï¼Œè¨˜å¾—æˆ´å€‹å¸½å­é˜²é¢¨å–”ã€‚"
    elif apparent_temp < 15:
        advice = "å¤©æ°£å†·å±å±ï¼Œå¯’æµç™¼å¨ï¼Œå‡ºé–€æ„›ç©¿ä¹ç‡’å–”ï¼"
    elif 15 <= apparent_temp < 21:
        advice = "é¢¨å¹ä¾†æ¶¼æ¶¼çš„ï¼Œæ—¥å¤œæº«å·®å¤§ï¼Œå‡ºé–€è¨˜å¾—å¸¶ä»¶è–„å¤–å¥—ã€‚"
    elif 21 <= apparent_temp < 27:
        advice = "å¤©æ°£å¾ˆé€Ÿè¥¿ (èˆ’é©)ï¼Œå¾®é¢¨å¾å¾ï¼Œè¶…é©åˆå‡ºé–€æ•£æ•£æ­¥ï¼"
    elif 27 <= apparent_temp < 32:
        advice = "å¤©æ°£æœ‰é»æ‚¶ç†±ï¼Œé€æ°£çŸ­è¢–ç©¿èµ·ä¾†ï¼Œè¨˜å¾—å¤šå–æ°´ã€‚"
    else: 
        advice = "æ—¥é ­èµ¤ç‚ç‚ï¼Œè¶…ç´šç†±ï¼é˜²æ›¬åšå¥½å°å¿ƒä¸­æš‘ï¼Œç›¡é‡å¾…åœ¨å†·æ°£æˆ¿ï¼"
    return advice

def calculate_lifestyle_indices(weather_elements, current_vals):
    curr_t = current_vals.get('temp', 25)
    curr_rh = current_vals.get('humidity', 75)
    curr_ws = current_vals.get('wind_speed', 2)
    curr_rain = current_vals.get('rain', 0)
    
    pop_12h = 0
    for item in weather_elements:
        e_name = item.get('elementName', item.get('ElementName'))
        if e_name == 'PoP12h':
            time_list = item.get('time', item.get('Time', []))
            if time_list:
                e_vals = time_list[0].get('elementValue', time_list[0].get('ElementValue', []))
                if e_vals:
                    val = e_vals[0].get('value', e_vals[0].get('Value', '0'))
                    try: pop_12h = int(val)
                    except: pop_12h = 0

    curr_at = curr_t + 0.33 * curr_rh / 100 * 6.105 * 2.718 ** (17.27 * curr_t / (237.7 + curr_t)) - 4
    curr_at = round(curr_at)

    if curr_t < 15: clothing = "åšå¤–å¥—"
    elif 15 <= curr_t < 20: clothing = "å¤¾å…‹/é¢¨è¡£"
    elif 20 <= curr_t < 26: clothing = "çŸ­è¢–+è–„å¤–å¥—"
    else: clothing = "é€æ°£çŸ­è¢–"

    if curr_rain > 0 or pop_12h > 40: cycling = "ä¸å»ºè­°"
    elif curr_ws > 5: cycling = "éœ€é˜²é¢¨"
    else: cycling = "éå¸¸é©å®œ"

    if pop_12h > 30: car_wash = "ä¸å®œ"
    else: car_wash = "é©å®œ"

    if curr_rain > 0 or curr_rh > 85: laundry = "ä¸å®œ"
    else: laundry = "é©å®œ"

    sunscreen = "ä¸­" if curr_t > 25 else "å¼±"
    skincare = "é‡ä¿æ¿•" if curr_rh < 50 else "æ§æ²¹æ¸…çˆ½"
    cold_risk = "æ³¨æ„ä¿æš–" if curr_t < 16 else "ä½é¢¨éšª"
    dog_walk = "ä¸æ¨è–¦" if curr_rain > 0 else "æ¨è–¦"
    sport = "å®¤å…§ä½³" if curr_rain > 0 else "æˆ¶å¤–ä½³"

    return {
        "clothing": clothing, "cycling": cycling, "sunscreen": sunscreen,
        "laundry": laundry, "car_wash": car_wash, "skincare": skincare,
        "cold_risk": cold_risk, "dog_walk": dog_walk, "sport": sport,
        "apparent_temp": curr_at 
    }

def fetch_data():
    cwa_key = os.getenv("CWA_API_KEY")
    moenv_key = os.getenv("MOENV_API_KEY")

    if not os.path.exists("data"):
        os.makedirs("data")

    tw_now = datetime.utcnow() + timedelta(hours=8)
    tw_now_str = tw_now.strftime("%Y-%m-%d %H:%M:%S")

    print(f"ğŸš€ å•Ÿå‹•æ°£è±¡ç«™: å°ç£æ™‚é–“ {tw_now_str}")

    aqi_map = {}
    try:
        if moenv_key:
            url_aqi = f"https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key={moenv_key}"
            res_aqi = requests.get(url_aqi).json()
            for record in res_aqi.get('records', []):
                county = record.get('county')
                aqi_val = record.get('aqi')
                if county and aqi_val: aqi_map[county] = int(aqi_val)
        print("âœ… AQI å®Œæˆ")
    except:
        print("âš ï¸ AQI å¤±æ•— (ä½¿ç”¨é è¨­å€¼)")

    valid_stations = []
    try:
        url_obs = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization={cwa_key}&format=JSON"
        res_obs = requests.get(url_obs).json()
        stations = res_obs['records']['Station']
        
        count = 0
        for st in stations:
            obs_time_str = st['ObsTime']['DateTime']
            obs_time = datetime.strptime(obs_time_str[:19], "%Y-%m-%dT%H:%M:%S")
            
            if (tw_now - obs_time).total_seconds() > 5400:
                continue 

            geo = st['GeoInfo']
            lat = float(geo['Coordinates'][0]['StationLatitude'])
            lon = float(geo['Coordinates'][0]['StationLongitude'])
            station_name = st['StationName']
            weather = st['WeatherElement']
            
            try:
                temp = float(weather['AirTemperature'])
                if temp > -50:
                    humid = float(weather['RelativeHumidity'])
                    wind = float(weather['WindSpeed'])
                    rain = float(weather['Now']['Precipitation'])
                    if humid < 0: humid = 75
                    if wind < 0: wind = 0
                    if rain < 0: rain = 0
                    valid_stations.append({
                        "name": station_name,
                        "lat": lat, "lon": lon,
                        "data": {"temp": temp, "humidity": humid, "wind_speed": wind, "rain": rain}
                    })
                    count += 1
            except: continue
        print(f"âœ… æœ‰æ•ˆä¸”æ–°é®®æ¸¬ç«™: {count} å€‹")
    except Exception as e:
        print(f"âŒ è§€æ¸¬å¤±æ•—: {e}")

    county_api_week = {
        "å®œè˜­ç¸£": "F-D0047-003", "æ¡ƒåœ’å¸‚": "F-D0047-007", "æ–°ç«¹ç¸£": "F-D0047-009",
        "è‹—æ —ç¸£": "F-D0047-013", "å½°åŒ–ç¸£": "F-D0047-017", "å—æŠ•ç¸£": "F-D0047-021",
        "é›²æ—ç¸£": "F-D0047-025", "å˜‰ç¾©ç¸£": "F-D0047-029", "å±æ±ç¸£": "F-D0047-033",
        "è‡ºæ±ç¸£": "F-D0047-037", "èŠ±è“®ç¸£": "F-D0047-041", "æ¾æ¹–ç¸£": "F-D0047-045",
        "åŸºéš†å¸‚": "F-D0047-049", "æ–°ç«¹å¸‚": "F-D0047-053", "å˜‰ç¾©å¸‚": "F-D0047-057",
        "è‡ºåŒ—å¸‚": "F-D0047-061", "é«˜é›„å¸‚": "F-D0047-065", "æ–°åŒ—å¸‚": "F-D0047-069",
        "è‡ºä¸­å¸‚": "F-D0047-073", "è‡ºå—å¸‚": "F-D0047-077", "é€£æ±Ÿç¸£": "F-D0047-081",
        "é‡‘é–€ç¸£": "F-D0047-085"
    }

    print("ğŸ“¡ é–‹å§‹é…å°èˆ‡è¨ˆç®—...")
    
    for city_name, api_id in county_api_week.items():
        try:
            url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/{api_id}?Authorization={cwa_key}&format=JSON"
            res = requests.get(url)
            data = res.json()
            
            records = data.get('records', {})
            locations_raw = []
            if 'locations' in records: locations_raw = records['locations'][0]['location']
            elif 'Locations' in records: locations_raw = records['Locations'][0]['Location']
            elif 'location' in records: locations_raw = records['location']
            
            for loc in locations_raw:
                town_name = loc.get('locationName', loc.get('LocationName', 'æœªçŸ¥'))
                weather_elements = loc.get('weatherElement', loc.get('WeatherElement', []))
                
                town_key = f"{city_name}{town_name}"
                geo_info = TOWN_GEO.get(town_key)
                
                # ğŸ›‘ é‡å°åé é„‰é®æ“´å¤§æœæŸ¥åŠå¾‘ (15km -> 35km)
                if geo_info:
                    town_lat, town_lon = geo_info
                    matched_station = None
                    min_dist = 99999.0
                    for st in valid_stations:
                        dist = calculate_distance(town_lat, town_lon, st['lat'], st['lon'])
                        if dist < min_dist:
                            min_dist = dist
                            matched_station = st
                    
                    final_obs_data = None
                    source_station_name = ""

                    if matched_station and min_dist < 35:
                        final_obs_data = matched_station['data']
                        source_station_name = matched_station['name']
                else:
                    final_obs_data = None
                    source_station_name = "é å ±æ¨ç®—(ç„¡åº§æ¨™)"

                forecast_wx = "å¤šé›²"
                forecast_temp_now = "25" # é è¨­å€¼ï¼Œå¾Œé¢æœƒè¢«çœŸé å ±è¦†è“‹
                daily_agg = {}

                for el in weather_elements:
                    e_name = el.get('elementName', el.get('ElementName'))
                    time_list = el.get('time', el.get('Time', []))
                    
                    if e_name == 'Wx' and time_list:
                         vals = time_list[0].get('elementValue', time_list[0].get('ElementValue', []))
                         if vals: forecast_wx = vals[0].get('value', 'å¤šé›²')
                    
                    # æŠ“å–ç¬¬ä¸€ç­†é å ±æº«åº¦ä½œç‚ºå®‰å…¨åº•ç·š
                    if e_name == 'T' and time_list:
                        vals = time_list[0].get('elementValue', time_list[0].get('ElementValue', []))
                        if vals: forecast_temp_now = vals[0].get('value', '25')

                    for t in time_list:
                        start_time = t.get('startTime', t.get('StartTime', ''))
                        vals = t.get('elementValue', t.get('ElementValue', []))
                        if not vals: continue
                        val_str = vals[0].get('value', '0')

                        if len(start_time) >= 10:
                            date_str = start_time[:10] 
                            if date_str not in daily_agg:
                                daily_agg[date_str] = { "temps": [], "pops": [], "wx": [] }
                            
                            if e_name == 'T':
                                try: daily_agg[date_str]["temps"].append(int(val_str))
                                except: pass
                            elif e_name == 'PoP12h':
                                try: daily_agg[date_str]["pops"].append(int(val_str))
                                except: pass
                            elif e_name == 'Wx':
                                daily_agg[date_str]["wx"].append(val_str)

                daily_forecast = []
                sorted_dates = sorted(daily_agg.keys())
                
                for date in sorted_dates:
                    data = daily_agg[date]
                    if data["temps"]:
                        day_display = date[5:].replace('-', '/')
                        wx_condition = max(set(data["wx"]), key=data["wx"].count) if data["wx"] else "å¤šé›²"
                        pop_prob = max(data["pops"]) if data["pops"] else 0

                        daily_forecast.append({
                            "day": day_display,
                            "high": max(data["temps"]),
                            "low": min(data["temps"]),
                            "condition": wx_condition,
                            "prob": f"{pop_prob}%"
                        })
                
                if final_obs_data:
                    final_temp = final_obs_data['temp']
                    final_rain = final_obs_data['rain']
                    final_ws = final_obs_data['wind_speed']
                    final_wx = "é›¨å¤©" if final_rain > 0 else forecast_wx 
                else:
                    # å¦‚æœæ²’è§€æ¸¬ï¼Œä½¿ç”¨è©²é„‰é®ä¸‹ä¸€å°æ™‚çš„ã€Œé å ±æº«åº¦ã€
                    final_temp = int(forecast_temp_now)
                    final_rain = 0
                    final_ws = 2
                    final_wx = forecast_wx
                    final_obs_data = {"temp": final_temp, "humidity": 75, "wind_speed": 2, "rain": 0}
                    source_station_name = "é å ±æ¨ç®—"

                indices = calculate_lifestyle_indices(weather_elements, final_obs_data)
                my_aqi = aqi_map.get(city_name, 35)

                pure_advice = get_taiwanese_quote(
                    apparent_temp=indices['apparent_temp'], 
                    weather=final_wx, 
                    is_raining=(final_rain > 0 or "é›¨" in final_wx),
                    wind_speed=final_ws
                )

                processed_data = {
                    "city": city_name,
                    "district": town_name,
                    "temp": str(int(final_temp)),
                    "apparent_temp": str(indices['apparent_temp']),
                    "weather": final_wx,
                    "aqi": my_aqi,
                    "station_source": source_station_name, 
                    "description": pure_advice,
                    "suggestions": indices,
                    "daily_forecast": daily_forecast[:7],
                    "update_time": tw_now_str 
                }

                file_path = f"data/{city_name}{town_name}.json"
                with open(file_path, "w", encoding="utf-8") as f:
                    json.dump(processed_data, f, ensure_ascii=False)
            
            print(f"âœ… {city_name} å®Œæˆ")
            
        except Exception as e:
            print(f"âŒ {city_name} éŒ¯èª¤: {e}")

    print("ğŸ‰ è³‡æ–™åº«æ›´æ–°å®Œç•¢ï¼")

if __name__ == "__main__":
    fetch_data()
