import requests
import json
import os
import time
import math
from datetime import datetime, timedelta

# --- 📍 全台 368 鄉鎮市區經緯度資料庫 ---
TOWN_GEO = {
    "基隆市仁愛區": [25.1276, 121.7392], "基隆市信義區": [25.1294, 121.7495], "基隆市中正區": [25.1408, 121.7588], "基隆市中山區": [25.1444, 121.7303], "基隆市安樂區": [25.1232, 121.7169], "基隆市暖暖區": [25.0998, 121.7335], "基隆市七堵區": [25.0958, 121.7126],
    "臺北市中正區": [25.0321, 121.5195], "臺北市大同區": [25.0645, 121.5133], "臺北市中山區": [25.0685, 121.5332], "臺北市松山區": [25.0583, 121.5586], "臺北市大安區": [25.0263, 121.5438], "臺北市萬華區": [25.0313, 121.4988], "臺北市信義區": [25.0326, 121.5647], "臺北市士林區": [25.1166, 121.5478], "臺北市北投區": [25.1320, 121.4987], "臺北市內湖區": [25.0836, 121.5944], "臺北市南港區": [25.0381, 121.6074], "臺北市文山區": [24.9937, 121.5705],
    "新北市板橋區": [25.0116, 121.4594], "新北市三重區": [25.0694, 121.4912], "新北市中和區": [24.9939, 121.4965], "新北市永和區": [25.0094, 121.5152], "新北市新莊區": [25.0360, 121.4496], "新北市新店區": [24.9680, 121.5413], "新北市樹林區": [24.9859, 121.4172], "新北市鶯歌區": [24.9542, 121.3484], "新北市三峽區": [24.9009, 121.3916], "新北市淡水區": [25.1764, 121.4429], "新北市汐止區": [25.0664, 121.6601], "新北市瑞芳區": [25.1086, 121.8058], "新北市土城區": [24.9723, 121.4442], "新北市蘆洲區": [25.0855, 121.4727], "新北市五股區": [25.0830, 121.4390], "新北市泰山區": [25.0594, 121.4276], "新北市林口區": [25.0784, 121.3857], "新北市深坑區": [25.0019, 121.6152], "新北市石碇區": [24.9904, 121.6608], "新北市坪林區": [24.9351, 121.7107], "新北市三芝區": [25.2346, 121.5037], "新北市石門區": [25.2755, 121.5582], "新北市八里區": [25.1275, 121.4019], "新北市平溪區": [25.0255, 121.7397], "新北市雙溪區": [25.0287, 121.8541], "新北市貢寮區": [25.0213, 121.9224], "新北市金山區": [25.2154, 121.6166], "新北市萬里區": [25.1724, 121.6669], "新北市烏來區": [24.8192, 121.5501],
    "桃園市桃園區": [24.9936, 121.3010], "桃園市中壢區": [24.9654, 121.2255], "桃園市大溪區": [24.8806, 121.2866], "桃園市楊梅區": [24.9087, 121.1458], "桃園市蘆竹區": [25.0504, 121.2891], "桃園市大園區": [25.0631, 121.1963], "桃園市龜山區": [25.0000, 121.3556], "桃園市八德區": [24.9493, 121.2965], "桃園市龍潭區": [24.8638, 121.2163], "桃園市平鎮區": [24.9443, 121.2131], "桃園市新屋區": [24.9708, 121.1039], "桃園市觀音區": [25.0347, 121.0827], "桃園市復興區": [24.8213, 121.3524],
    "新竹市東區": [24.8016, 121.0062], "新竹市北區": [24.8142, 120.9575], "新竹市香山區": [24.7679, 120.9254],
    "新竹縣竹北市": [24.8420, 121.0022], "新竹縣竹東鎮": [24.7335, 121.0821], "新竹縣新埔鎮": [24.8306, 121.0728], "新竹縣關西鎮": [24.7888, 121.1822], "新竹縣湖口鄉": [24.9038, 121.0427], "新竹縣新豐鄉": [24.8732, 120.9859], "新竹縣芎林鄉": [24.7744, 121.0772], "新竹縣橫山鄉": [24.7119, 121.1165], "新竹縣北埔鄉": [24.6908, 121.0558], "新竹縣寶山鄉": [24.7336, 121.0261], "新竹縣峨眉鄉": [24.6756, 121.0205], "新竹縣尖石鄉": [24.6467, 121.3149], "新竹縣五峰鄉": [24.5855, 121.1272],
    "苗栗縣苗栗市": [24.5649, 120.8152], "苗栗縣頭份市": [24.6872, 120.9069], "苗栗縣苑裡鎮": [24.4265, 120.6725], "苗栗縣通霄鎮": [24.4936, 120.6974], "苗栗縣竹南鎮": [24.6932, 120.8711], "苗栗縣後龍鎮": [24.6200, 120.7936], "苗栗縣卓蘭鎮": [24.3168, 120.8354], "苗栗縣大湖鄉": [24.4087, 120.8654], "苗栗縣公館鄉": [24.5029, 120.8322], "苗栗縣銅鑼鄉": [24.4746, 120.7941], "苗栗縣南庄鄉": [24.5910, 121.0089], "苗栗縣頭屋鄉": [24.5768, 120.8655], "苗栗縣三義鄉": [24.3984, 120.7677], "苗栗縣西湖鄉": [24.5369, 120.7711], "苗栗縣造橋鄉": [24.6366, 120.8744], "苗栗縣三灣鄉": [24.6548, 120.9507], "苗栗縣獅潭鄉": [24.5428, 120.9161], "苗栗縣泰安鄉": [24.4172, 121.0366],
    "臺中市中區": [24.1413, 120.6806], "臺中市東區": [24.1352, 120.7042], "臺中市南區": [24.1169, 120.6558], "臺中市西區": [24.1408, 120.6562], "臺中市北區": [24.1633, 120.6784], "臺中市西屯區": [24.1793, 120.6358], "臺中市南屯區": [24.1328, 120.6063], "臺中市北屯區": [24.1843, 120.7251], "臺中市豐原區": [24.2505, 120.7231], "臺中市東勢區": [24.2393, 120.8407], "臺中市大甲區": [24.3481, 120.6384], "臺中市清水區": [24.2709, 120.5735], "臺中市沙鹿區": [24.2263, 120.5772], "臺中市梧棲區": [24.2559, 120.5367], "臺中市后里區": [24.3045, 120.7180], "臺中市神岡區": [24.2582, 120.6627], "臺中市潭子區": [24.2091, 120.7063], "臺中市大雅區": [24.2274, 120.6482], "臺中市新社區": [24.2157, 120.8242], "臺中市石岡區": [24.2762, 120.7770], "臺中市外埔區": [24.3168, 120.6491], "臺中市大安區": [24.3562, 120.5849], "臺中市烏日區": [24.0898, 120.6334], "臺中市大肚區": [24.1528, 120.5486], "臺中市龍井區": [24.2023, 120.5435], "臺中市霧峰區": [24.0450, 120.7139], "臺中市太平區": [24.1197, 120.7816], "臺中市大里區": [24.0883, 120.6953], "臺中市和平區": [24.2882, 121.0965],
    "彰化縣彰化市": [24.0792, 120.5459], "彰化縣鹿港鎮": [24.0569, 120.4357], "彰化縣和美鎮": [24.1118, 120.5002], "彰化縣線西鄉": [24.1332, 120.4705], "彰化縣伸港鄉": [24.1554, 120.4906], "彰化縣福興鄉": [24.0381, 120.4429], "彰化縣秀水鄉": [24.0371, 120.5036], "彰化縣花壇鄉": [24.0256, 120.5532], "彰化縣芬園鄉": [24.0135, 120.6277], "彰化縣員林市": [23.9592, 120.5731], "彰化縣溪湖鎮": [23.9576, 120.4851], "彰化縣田中鎮": [23.8606, 120.5878], "彰化縣大村鄉": [23.9934, 120.5436], "彰化縣埔鹽鄉": [23.9961, 120.4635], "彰化縣埔心鄉": [23.9535, 120.5317], "彰化縣永靖鄉": [23.9213, 120.5484], "彰化縣社頭鄉": [23.8967, 120.5822], "彰化縣二水鄉": [23.8078, 120.6179], "彰化縣北斗鎮": [23.8749, 120.5233], "彰化縣二林鎮": [23.8986, 120.3789], "彰化縣田尾鄉": [23.8914, 120.5273], "彰化縣埤頭鄉": [23.8631, 120.4571], "彰化縣芳苑鄉": [23.9318, 120.3340], "彰化縣大城鄉": [23.8569, 120.3236], "彰化縣竹塘鄉": [23.8504, 120.4170], "彰化縣溪州鄉": [23.8517, 120.5029],
    "南投縣南投市": [23.9189, 120.6728], "南投縣埔里鎮": [23.9654, 120.9631], "南投縣草屯鎮": [23.9882, 120.6974], "南投縣竹山鎮": [23.7549, 120.6865], "南投縣集集鎮": [23.8293, 120.7854], "南投縣名間鄉": [23.8703, 120.6713], "南投縣鹿谷鄉": [23.7441, 120.7516], "南投縣中寮鄉": [23.8969, 120.7629], "南投縣魚池鄉": [23.8953, 120.9328], "南投縣國姓鄉": [24.0436, 120.8523], "南投縣水里鄉": [23.8115, 120.8509], "南投縣信義鄉": [23.6936, 120.9702], "南投縣仁愛鄉": [24.0242, 121.1309],
    "雲林縣斗六市": [23.7081, 120.5441], "雲林縣斗南鎮": [23.6766, 120.4851], "雲林縣虎尾鎮": [23.7088, 120.4357], "雲林縣西螺鎮": [23.7917, 120.4636], "雲林縣土庫鎮": [23.6796, 120.3853], "雲林縣北港鎮": [23.5786, 120.2981], "雲林縣古坑鄉": [23.6262, 120.5898], "雲林縣大埤鄉": [23.6421, 120.4288], "雲林縣莿桐鄉": [23.7635, 120.5284], "雲林縣林內鄉": [23.7601, 120.6121], "雲林縣二崙鄉": [23.7744, 120.4172], "雲林縣崙背鄉": [23.7588, 120.3547], "雲林縣麥寮鄉": [23.7533, 120.2529], "雲林縣東勢鄉": [23.6781, 120.2575], "雲林縣褒忠鄉": [23.6983, 120.3135], "雲林縣臺西鄉": [23.7032, 120.2030], "雲林縣元長鄉": [23.6457, 120.3129], "雲林縣四湖鄉": [23.6397, 120.2227], "雲林縣口湖鄉": [23.5721, 120.1834], "雲林縣水林鄉": [23.5683, 120.2464],
    "嘉義市東區": [23.4839, 120.4646], "嘉義市西區": [23.4796, 120.4293],
    "嘉義縣太保市": [23.4588, 120.3298], "嘉義縣朴子市": [23.4660, 120.2443], "嘉義縣布袋鎮": [23.3768, 120.1717], "嘉義縣大林鎮": [23.6009, 120.4659], "嘉義縣民雄鄉": [23.5483, 120.4431], "嘉義縣溪口鄉": [23.6067, 120.3957], "嘉義縣新港鄉": [23.5516, 120.3475], "嘉義縣六腳鄉": [23.4984, 120.2917], "嘉義縣東石鄉": [23.4568, 120.1746], "嘉義縣義竹鄉": [23.3364, 120.2452], "嘉義縣鹿草鄉": [23.4116, 120.3126], "嘉義縣水上鄉": [23.4284, 120.4140], "嘉義縣中埔鄉": [23.4184, 120.5298], "嘉義縣竹崎鄉": [23.5049, 120.5843], "嘉義縣梅山鄉": [23.5728, 120.6166], "嘉義縣番路鄉": [23.4475, 120.6409], "嘉義縣大埔鄉": [23.2989, 120.6277], "嘉義縣阿里山鄉": [23.4398, 120.7675],
    "臺南市新營區": [23.3080, 120.3160], "臺南市鹽水區": [23.3243, 120.2647], "臺南市白河區": [23.3444, 120.4501], "臺南市柳營區": [23.2842, 120.3424], "臺南市後壁區": [23.3647, 120.3551], "臺南市東山區": [23.3106, 120.4277], "臺南市麻豆區": [23.1868, 120.2464], "臺南市下營區": [23.2285, 120.2690], "臺南市六甲區": [23.2241, 120.3424], "臺南市官田區": [23.1906, 120.3392], "臺南市大內區": [23.1232, 120.3756], "臺南市佳里區": [23.1672, 120.1764], "臺南市學甲區": [23.2359, 120.1802], "臺南市西港區": [23.1233, 120.2036], "臺南市七股區": [23.1408, 120.1348], "臺南市將軍區": [23.1994, 120.1420], "臺南市北門區": [23.2676, 120.1246], "臺南市新化區": [23.0384, 120.3090], "臺南市善化區": [23.1326, 120.2929], "臺南市新市區": [23.0782, 120.2934], "臺南市安定區": [23.1193, 120.2351], "臺南市山上區": [23.0970, 120.3708], "臺南市玉井區": [23.1259, 120.4619], "臺南市楠西區": [23.1895, 120.5050], "臺南市南化區": [23.0805, 120.5204], "臺南市左鎮區": [23.0456, 120.4260], "臺南市仁德區": [22.9554, 120.2541], "臺南市歸仁區": [22.9666, 120.2949], "臺南市關廟區": [22.9563, 120.3444], "臺南市龍崎區": [22.9515, 120.3951], "臺南市永康區": [23.0232, 120.2574], "臺南市東區": [22.9839, 120.2227], "臺南市南區": [22.9585, 120.1843], "臺南市北區": [23.0076, 120.2058], "臺南市安南區": [23.0478, 120.1834], "臺南市安平區": [23.0003, 120.1607], "臺南市中西區": [22.9926, 120.1979],
    "高雄市鹽埕區": [22.6247, 120.2839], "高雄市鼓山區": [22.6524, 120.2735], "高雄市左營區": [22.6865, 120.2952], "高雄市楠梓區": [22.7291, 120.3276], "高雄市三民區": [22.6508, 120.3235], "高雄市新興區": [22.6284, 120.3087], "高雄市前金區": [22.6268, 120.2941], "高雄市苓雅區": [22.6253, 120.3340], "高雄市前鎮區": [22.5852, 120.3168], "高雄市旗津區": [22.5714, 120.2797], "高雄市小港區": [22.5484, 120.3661], "高雄市鳳山區": [22.6176, 120.3637], "高雄市林園區": [22.4975, 120.3958], "高雄市大寮區": [22.6025, 120.4103], "高雄市大樹區": [22.6841, 120.4435], "高雄市大社區": [22.7303, 120.3546], "高雄市仁武區": [22.7001, 120.3551], "高雄市鳥松區": [22.6599, 120.3758], "高雄市岡山區": [22.8094, 120.2858], "高雄市橋頭區": [22.7570, 120.3045], "高雄市燕巢區": [22.7876, 120.3705], "高雄市田寮區": [22.8687, 120.3804], "高雄市阿蓮區": [22.8874, 120.3259], "高雄市路竹區": [22.8654, 120.2580], "高雄市湖內區": [22.9056, 120.2241], "高雄市茄萣區": [22.9037, 120.1868], "高雄市永安區": [22.8166, 120.2285], "高雄市彌陀區": [22.7816, 120.2443], "高雄市梓官區": [22.7569, 120.2649], "高雄市旗山區": [22.8986, 120.4795], "高雄市美濃區": [22.9055, 120.5401], "高雄市六龜區": [23.0033, 120.6559], "高雄市甲仙區": [23.1009, 120.6139], "高雄市杉林區": [22.9918, 120.5408], "高雄市內門區": [22.9463, 120.4630], "高雄市茂林區": [22.8931, 120.6975], "高雄市桃源區": [23.1950, 120.8066], "高雄市那瑪夏區": [23.2427, 120.7107],
    "屏東縣屏東市": [22.6713, 120.4852], "屏東縣潮州鎮": [22.5513, 120.5422], "屏東縣東港鎮": [22.4674, 120.4526], "屏東縣恆春鎮": [22.0001, 120.7410], "屏東縣萬丹鄉": [22.5855, 120.4842], "屏東縣長治鄉": [22.6841, 120.5282], "屏東縣麟洛鄉": [22.6472, 120.5262], "屏東縣九如鄉": [22.7397, 120.4883], "屏東縣里港鄉": [22.7811, 120.4936], "屏東縣鹽埔鄉": [22.7473, 120.5739], "屏東縣高樹鄉": [22.8256, 120.6015], "屏東縣萬巒鄉": [22.5746, 120.5898], "屏東縣內埔鄉": [22.6258, 120.5794], "屏東縣竹田鄉": [22.5888, 120.5404], "屏東縣新埤鄉": [22.4746, 120.5552], "屏東縣枋寮鄉": [22.3688, 120.5960], "屏東縣新園鄉": [22.5369, 120.4600], "屏東縣崁頂鄉": [22.5113, 120.5126], "屏東縣林邊鄉": [22.4344, 120.5152], "屏東縣南州鄉": [22.4939, 120.5128], "屏東縣佳冬鄉": [22.4187, 120.5492], "屏東縣琉球鄉": [22.3458, 120.3664], "屏東縣車城鄉": [22.0722, 120.7126], "屏東縣滿州鄉": [22.0308, 120.8354], "屏東縣枋山鄉": [22.2570, 120.6548], "屏東縣三地門鄉": [22.7483, 120.6865], "屏東縣霧臺鄉": [22.7460, 120.7303], "屏東縣瑪家鄉": [22.6517, 120.6627], "屏東縣泰武鄉": [22.6074, 120.6644], "屏東縣來義鄉": [22.5298, 120.6555], "屏東縣春日鄉": [22.4042, 120.6548], "屏東縣獅子鄉": [22.2223, 120.7380], "屏東縣牡丹鄉": [22.1471, 120.8037],
    "宜蘭縣宜蘭市": [24.7570, 121.7530], "宜蘭縣羅東鎮": [24.6759, 121.7675], "宜蘭縣蘇澳鎮": [24.5956, 121.8413], "宜蘭縣頭城鎮": [24.8582, 121.8242], "宜蘭縣礁溪鄉": [24.8214, 121.7684], "宜蘭縣壯圍鄉": [24.7645, 121.8020], "宜蘭縣員山鄉": [24.7437, 121.7145], "宜蘭縣冬山鄉": [24.6366, 121.7904], "宜蘭縣五結鄉": [24.6974, 121.7997], "宜蘭縣三星鄉": [24.6648, 121.6421], "宜蘭縣大同鄉": [24.6368, 121.5721], "宜蘭縣南澳鄉": [24.4447, 121.7770],
    "花蓮縣花蓮市": [23.9912, 121.6015], "花蓮縣鳳林鎮": [23.7547, 121.4646], "花蓮縣玉里鎮": [23.3610, 121.3289], "花蓮縣新城鄉": [24.0360, 121.6247], "花蓮縣吉安鄉": [23.9748, 121.5833], "花蓮縣壽豐鄉": [23.8647, 121.5222], "花蓮縣光復鄉": [23.6559, 121.4326], "花蓮縣豐濱鄉": [23.6062, 121.5471], "花蓮縣瑞穗鄉": [23.5186, 121.3837], "花蓮縣富里鄉": [23.1897, 121.2618], "花蓮縣秀林鄉": [24.1678, 121.6033], "花蓮縣萬榮鄉": [23.7550, 121.3789], "花蓮縣卓溪鄉": [23.3621, 121.1685],
    "臺東縣臺東市": [22.7554, 121.1504], "臺東縣成功鎮": [23.1022, 121.3753], "臺東縣關山鎮": [23.0487, 121.1633], "臺東縣卑南鄉": [22.8252, 121.0538], "臺東縣鹿野鄉": [22.9238, 121.1528], "臺東縣池上鄉": [23.1235, 121.2185], "臺東縣東河鄉": [22.9734, 121.2989], "臺東縣長濱鄉": [23.3155, 121.4552], "臺東縣太麻里鄉": [22.6154, 120.9996], "臺東縣大武鄉": [22.3617, 120.9080], "臺東縣綠島鄉": [22.6669, 121.4816], "臺東縣海端鄉": [23.1904, 121.0544], "臺東縣延平鄉": [22.9103, 121.0028], "臺東縣金峰鄉": [22.6087, 120.9575], "臺東縣達仁鄉": [22.2965, 120.8529], "臺東縣蘭嶼鄉": [22.0526, 121.5487],
    "澎湖縣馬公市": [23.5658, 119.5630], "澎湖縣湖西鄉": [23.5855, 119.6483], "澎湖縣白沙鄉": [23.6496, 119.5937], "澎湖縣西嶼鄉": [23.6030, 119.5168], "澎湖縣望安鄉": [23.3688, 119.4996], "澎湖縣七美鄉": [23.2088, 119.4283],
    "金門縣金城鎮": [24.4168, 118.3168], "金門縣金沙鎮": [24.4891, 118.4124], "金門縣金湖鎮": [24.4449, 118.4111], "金門縣金寧鄉": [24.4557, 118.3242], "金門縣烈嶼鄉": [24.4259, 118.2435], "金門縣烏坵鄉": [24.9919, 119.4443],
    "連江縣南竿鄉": [26.1578, 119.9329], "連江縣北竿鄉": [26.2239, 119.9965], "連江縣莒光鄉": [25.9736, 119.9404], "連江縣東引鄉": [26.3683, 120.4939]
}

# --- 📐 數學小教室：計算地球兩點距離 (Haversine 公式) ---
def calculate_distance(lat1, lon1, lat2, lon2):
    R = 6371  # 地球半徑 (公里)
    dLat = math.radians(lat2 - lat1)
    dLon = math.radians(lon2 - lon1)
    a = math.sin(dLat/2) * math.sin(dLat/2) + \
        math.cos(math.radians(lat1)) * math.cos(math.radians(lat2)) * \
        math.sin(dLon/2) * math.sin(dLon/2)
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1-a))
    return R * c # 回傳距離 (km)

# --- 🧠 生活指數計算 ---
def calculate_lifestyle_indices(weather_elements, current_vals):
    curr_t = current_vals.get('temp', 25)
    curr_rh = current_vals.get('humidity', 75)
    curr_ws = current_vals.get('wind_speed', 2)
    curr_rain = current_vals.get('rain', 0)
    
    pop_12h = 0
    for item in weather_elements:
        e_name = item.get('elementName', item.get('ElementName'))
        if e_name == 'PoP12h':
            time_list = item.get('time', item.get('Time', []))
            if time_list:
                e_vals = time_list[0].get('elementValue', time_list[0].get('ElementValue', []))
                if e_vals:
                    val = e_vals[0].get('value', e_vals[0].get('Value', '0'))
                    try: pop_12h = int(val)
                    except: pop_12h = 0

    curr_at = curr_t + 0.33 * curr_rh / 100 * 6.105 * 2.718 ** (17.27 * curr_t / (237.7 + curr_t)) - 4

    if curr_t < 15: clothing = "厚外套"
    elif 15 <= curr_t < 20: clothing = "夾克/風衣"
    elif 20 <= curr_t < 26: clothing = "短袖+薄外套"
    else: clothing = "透氣短袖"

    if curr_rain > 0 or pop_12h > 40: cycling = "不建議"
    elif curr_ws > 5: cycling = "需防風"
    else: cycling = "非常適宜"

    if pop_12h > 30: car_wash = "不宜"
    else: car_wash = "適宜"

    if curr_rain > 0 or curr_rh > 85: laundry = "不宜"
    else: laundry = "適宜"

    sunscreen = "中" if curr_t > 25 else "弱"
    skincare = "重保濕" if curr_rh < 50 else "控油清爽"
    cold_risk = "注意保暖" if curr_t < 16 else "低風險"
    dog_walk = "不推薦" if curr_rain > 0 else "推薦"
    sport = "室內佳" if curr_rain > 0 else "戶外佳"

    return {
        "clothing": clothing, "cycling": cycling, "sunscreen": sunscreen,
        "laundry": laundry, "car_wash": car_wash, "skincare": skincare,
        "cold_risk": cold_risk, "dog_walk": dog_walk, "sport": sport
    }

def fetch_data():
    cwa_key = os.getenv("CWA_API_KEY")
    moenv_key = os.getenv("MOENV_API_KEY")

    if not os.path.exists("data"):
        os.makedirs("data")

    # 🇹🇼 設定「台灣標準時間」(UTC+8) 作為系統基準時間
    # GitHub Action 伺服器在 UTC (美國)，所以要手動加 8 小時
    tw_now = datetime.utcnow() + timedelta(hours=8)
    tw_now_str = tw_now.strftime("%Y-%m-%d %H:%M:%S")

    print(f"🚀 啟動氣象站: 台灣時間 {tw_now_str} (已校正時區)")

    # 1. AQI
    aqi_map = {}
    try:
        if moenv_key:
            url_aqi = f"https://data.moenv.gov.tw/api/v2/aqx_p_432?api_key={moenv_key}"
            res_aqi = requests.get(url_aqi).json()
            for record in res_aqi.get('records', []):
                county = record.get('county')
                aqi_val = record.get('aqi')
                if county and aqi_val: aqi_map[county] = int(aqi_val)
        print("✅ AQI 完成")
    except:
        print("⚠️ AQI 失敗 (使用預設值)")

    # 2. 真實觀測站 (加入「時間賞味期限」過濾，剔除殭屍測站)
    valid_stations = []
    try:
        url_obs = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/O-A0003-001?Authorization={cwa_key}&format=JSON"
        res_obs = requests.get(url_obs).json()
        stations = res_obs['records']['Station']
        
        count = 0
        for st in stations:
            # ⏳ 取得氣象署該筆資料的時間
            obs_time_str = st['ObsTime']['DateTime'] # 例: 2026-01-23T12:00:00+08:00
            
            # 將氣象署的時間字串轉換為 Python datetime (忽略時區字串，只取前 19 碼)
            obs_time = datetime.strptime(obs_time_str[:19], "%Y-%m-%dT%H:%M:%S")
            
            # 🛑 核心防線：資料賞味期限為「1.5 小時 (5400秒)」
            # 拿【台灣現在時間 (tw_now)】去減【測站回傳時間 (obs_time)】
            if (tw_now - obs_time).total_seconds() > 5400:
                continue # 這筆資料太舊了，直接跳過這個測站！

            geo = st['GeoInfo']
            lat = float(geo['Coordinates'][0]['StationLatitude'])
            lon = float(geo['Coordinates'][0]['StationLongitude'])
            station_name = st['StationName']
            weather = st['WeatherElement']
            
            try:
                temp = float(weather['AirTemperature'])
                if temp > -50:
                    humid = float(weather['RelativeHumidity'])
                    wind = float(weather['WindSpeed'])
                    rain = float(weather['Now']['Precipitation'])
                    if humid < 0: humid = 75
                    if wind < 0: wind = 0
                    if rain < 0: rain = 0
                    valid_stations.append({
                        "name": station_name,
                        "lat": lat, "lon": lon,
                        "data": {"temp": temp, "humidity": humid, "wind_speed": wind, "rain": rain}
                    })
                    count += 1
            except: continue
        print(f"✅ 有效且新鮮測站: {count} 個 (已剔除過期殭屍測站)")
    except Exception as e:
        print(f"❌ 觀測失敗: {e}")

    # 3. 處理 368 鄉鎮
    county_api_week = {
        "宜蘭縣": "F-D0047-003", "桃園市": "F-D0047-007", "新竹縣": "F-D0047-009",
        "苗栗縣": "F-D0047-013", "彰化縣": "F-D0047-017", "南投縣": "F-D0047-021",
        "雲林縣": "F-D0047-025", "嘉義縣": "F-D0047-029", "屏東縣": "F-D0047-033",
        "臺東縣": "F-D0047-037", "花蓮縣": "F-D0047-041", "澎湖縣": "F-D0047-045",
        "基隆市": "F-D0047-049", "新竹市": "F-D0047-053", "嘉義市": "F-D0047-057",
        "臺北市": "F-D0047-061", "高雄市": "F-D0047-065", "新北市": "F-D0047-069",
        "臺中市": "F-D0047-073", "臺南市": "F-D0047-077", "連江縣": "F-D0047-081",
        "金門縣": "F-D0047-085"
    }

    print("📡 開始配對與計算...")
    
    for city_name, api_id in county_api_week.items():
        try:
            url = f"https://opendata.cwa.gov.tw/api/v1/rest/datastore/{api_id}?Authorization={cwa_key}&format=JSON"
            res = requests.get(url)
            data = res.json()
            
            records = data.get('records', {})
            locations_raw = []
            if 'locations' in records: locations_raw = records['locations'][0]['location']
            elif 'Locations' in records: locations_raw = records['Locations'][0]['Location']
            elif 'location' in records: locations_raw = records['location']
            
            for loc in locations_raw:
                town_name = loc.get('locationName', loc.get('LocationName', '未知'))
                weather_elements = loc.get('weatherElement', loc.get('WeatherElement', []))
                
                town_key = f"{city_name}{town_name}"
                geo_info = TOWN_GEO.get(town_key)
                
                if geo_info:
                    town_lat, town_lon = geo_info
                    
                    matched_station = None
                    min_dist = 99999.0
                    for st in valid_stations:
                        dist = calculate_distance(town_lat, town_lon, st['lat'], st['lon'])
                        if dist < min_dist:
                            min_dist = dist
                            matched_station = st
                    
                    final_obs_data = None
                    source_station_name = ""

                    if matched_station and min_dist < 15:
                        final_obs_data = matched_station['data']
                        source_station_name = matched_station['name']
                else:
                    final_obs_data = None
                    source_station_name = "預報推算(無座標)"

                # --- 預報解析 ---
                forecast_wx = "多雲"
                daily_agg = {}

                for el in weather_elements:
                    e_name = el.get('elementName', el.get('ElementName'))
                    time_list = el.get('time', el.get('Time', []))
                    
                    if e_name == 'Wx' and time_list:
                         vals = time_list[0].get('elementValue', time_list[0].get('ElementValue', []))
                         if vals: forecast_wx = vals[0].get('value', '多雲')

                    for t in time_list:
                        start_time = t.get('startTime', t.get('StartTime', ''))
                        vals = t.get('elementValue', t.get('ElementValue', []))
                        if not vals: continue
                        val_str = vals[0].get('value', '0')

                        if len(start_time) >= 10:
                            date_str = start_time[:10] 
                            
                            if date_str not in daily_agg:
                                daily_agg[date_str] = { "temps": [], "pops": [], "wx": [] }
                            
                            if e_name == 'T':
                                try: daily_agg[date_str]["temps"].append(int(val_str))
                                except: pass
                            elif e_name == 'PoP12h':
                                try: daily_agg[date_str]["pops"].append(int(val_str))
                                except: pass
                            elif e_name == 'Wx':
                                daily_agg[date_str]["wx"].append(val_str)

                daily_forecast = []
                sorted_dates = sorted(daily_agg.keys())
                
                for date in sorted_dates:
                    data = daily_agg[date]
                    if data["temps"]:
                        day_display = date[5:].replace('-', '/')
                        wx_condition = max(set(data["wx"]), key=data["wx"].count) if data["wx"] else "多雲"
                        pop_prob = max(data["pops"]) if data["pops"] else 0

                        daily_forecast.append({
                            "day": day_display,
                            "high": max(data["temps"]),
                            "low": min(data["temps"]),
                            "condition": wx_condition,
                            "prob": f"{pop_prob}%"
                        })
                
                # 最終數據整合
                if final_obs_data:
                    final_temp = final_obs_data['temp']
                    final_rain = final_obs_data['rain']
                    final_wx = "雨天" if final_rain > 0 else forecast_wx 
                else:
                    if daily_forecast:
                        final_temp = (daily_forecast[0]['high'] + daily_forecast[0]['low']) / 2
                    else:
                        final_temp = 25
                    final_rain = 0
                    final_wx = forecast_wx
                    final_obs_data = {"temp": final_temp, "humidity": 75, "wind_speed": 2, "rain": 0}
                    source_station_name = "預報推算"

                indices = calculate_lifestyle_indices(weather_elements, final_obs_data)
                my_aqi = aqi_map.get(city_name, 35)

                processed_data = {
                    "city": city_name,
                    "district": town_name,
                    "temp": str(int(final_temp)),
                    "apparent_temp": str(int(final_temp - 2)),
                    "weather": final_wx,
                    "aqi": my_aqi,
                    "station_source": source_station_name, 
                    "suggestions": indices,
                    "daily_forecast": daily_forecast[:7],
                    "update_time": tw_now_str # 這裡現在會顯示正確的台灣時間了！
                }

                file_path = f"data/{city_name}{town_name}.json"
                with open(file_path, "w", encoding="utf-8") as f:
                    json.dump(processed_data, f, ensure_ascii=False)
            
            print(f"✅ {city_name} 完成")
            
        except Exception as e:
            print(f"❌ {city_name} 錯誤: {e}")

    print("🎉 資料庫更新完畢！(殭屍測站已清除，時間已校正)")

if __name__ == "__main__":
    fetch_data()
